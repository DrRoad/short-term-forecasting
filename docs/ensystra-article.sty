%% ensystra-article.sty
%% Copyright 2019 Nithiya Streethran (nmstreethran@gmail.com)
% Custom article style with ENSYSTRA logo and EU funding info in the header and footer respectively
% To be used with documents converted using Pandoc
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Nithiya Streethran (nmstreethran@gmail.com).
%
% This work consists of the file ensystra-article.sty

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ensystra-article}

% IMPORTANT PACKAGES ----------------------------
\emergencystretch 3em % avoid overfulls in right margin 
\usepackage[a4paper]{geometry}
\geometry{margin=2.5cm,headheight=34pt} % page margins and space for header and footer 
\usepackage[UKenglish]{babel}
\usepackage[utf8]{inputenc} % encoding
\usepackage[T1]{fontenc} % ^
\usepackage{textcomp} % symbols
\usepackage{lmodern} % latin modern fonts % http://www.tug.dk/FontCatalogue/	
\usepackage{mathpazo} % mathpazo (palatino) serif font for body + math
\usepackage{sectsty} % for setting frontmatter and section headings to sans serif
\allsectionsfont{\raggedright\normalfont\sffamily\bfseries} % ^ bold + sans serif section headings; aligned left
\usepackage{amsmath,amsfonts} % for equation / math typesetting
\usepackage{enumitem} % to modify numbered lists
\addto\captionsUKenglish{\renewcommand\contentsname{Table of Contents}} % change title of toc
\usepackage{pdflscape} % for changing page orientation
\usepackage{listings}
\renewcommand{\lstlistlistingname}{List of Listings}
\usepackage{csquotes}
\usepackage{fontawesome,academicons} % icons
\usepackage{pdfpages} % for inserting pdf documents
\usepackage[nottoc,notbib]{tocbibind} % adding lists to the toc 

% METADATA, HYPERLINKS AND COLOURS -------------------------
\usepackage{hyperxmp} 
\usepackage[hidelinks,pdftex,
pdfauthor={\auth},
pdftitle={\doctitle},
pdfsubject={\projtitle},
pdfkeywords={\keywords}]{hyperref} % hyperlinks without borders, pdf metadata
\title{\sffamily\textbf{\doctitle}} % bold + sans serif title
\author{\sffamily\auth\footnote{\uni} \footnote{Email: \href{mailto:\email}{\ttfamily\email}}} % sans serif author, with affiliation and email in footnotes
\date{\sffamily\dat} % sans serif date
\hypersetup{colorlinks=true,linkcolor=blue,urlcolor=blue,citecolor=blue,pdfcopyright=\copyright,pdflicenseurl=\licenseurl,pdfcontactemail=\email} % hyperlink formatting 

% HEADER AND FOOTER -----------------------------
\usepackage{fancyhdr} % for header and footer
\pagestyle{fancy}
\fancypagestyle{plain}{
	\fancyhf{}
	\renewcommand{\headrulewidth}{0pt}
	\fancyfoot[C]{\sffamily\thepage}
} 
\fancyhf{} % sets both header and footer to nothing
\renewcommand{\headrulewidth}{0pt} % remove horizontal line from header 
\fancyhead[LE,RO]{\includegraphics[width=.2\textwidth]{logos/ensystra-ls.png}\vspace*{-.2cm}} % ENSYSTRA logo
\fancyfoot[LE,RO]{\sffamily\thepage} % page number
\fancyfoot[RE,LO]{\vspace*{-.4cm}\begin{tikzpicture}\node (A) {\includegraphics[width=.08\textwidth]{logos/eu.jpg}};\node (capt) [right=of A,text width=.45\linewidth,align=left,font=\tiny,xshift=-1cm]{\sffamily This project has received funding from the European Union's Horizon 2020 research and innovation programme under the Marie SkÅ‚odowska-Curie grant agreement No: 765515.};\end{tikzpicture}} % EU logo and funding info 
\fancyhead[LO]{\auth} % author
\fancyhead[RE]{\textit{\doctitle}}  

% FLOATS ----------------------------
\usepackage[font=small,labelfont=bf]{caption} % caption font size = small
\usepackage{floatrow} % to modify float settings 
\floatsetup[table]{capposition=top} % force table captions on top
\usepackage[section]{placeins} % place floats (images/tables) within its specified (sub)(sub)section
\makeatletter % keep in section / subsection
\AtBeginDocument{%
	\expandafter\renewcommand\expandafter\section\expandafter{%
		\expandafter\@fb@secFB\section
	}%
}
\makeatother %
\usepackage{longtable} % tables 
\usepackage{booktabs} % 
\usepackage{threeparttablex} % for "ThreePartTable" environment 
\renewcommand{\arraystretch}{1.2} % More space between rows 
\let\oldtabular\longtable
\renewcommand{\longtable}{\footnotesize\oldtabular} % table font size
\usepackage{graphicx}
\graphicspath{ {../images/} } 
\usepackage{tikz,shapepar,smartdiagram,tikzpagenodes,subfigure}
\usetikzlibrary{positioning,decorations.pathreplacing,shapes.geometric,backgrounds,arrows.meta,arrows,shadows,trees}

% BIBLIOGRAPHY --------------------------------------------------
\usepackage[backend=biber,style=alphabetic,urldate=long,maxalphanames=1]{biblatex} % only first author's name will be used in the alphanumeric label
\usepackage{xpatch} % to remove empty parentheses if year not provided for @online
\xpatchbibdriver{online}
{\printtext[parens]{\usebibmacro{date}}}
{\iffieldundef{year}{}{\printtext[parens]{\usebibmacro{date}}}}
{}{} 
\renewbibmacro*{doi+eprint+url}{% % if DOI is not present, print eprint; if eprint is not present, print URL
	\printfield{doi}%
	\newunit\newblock%
	\newunit\newblock%
	\iffieldundef{doi}{%
		\usebibmacro{eprint}%
		\iffieldundef{eprint}{%
			\usebibmacro{url+urldate}}}%
	{}%
}
\appto{\bibsetup}{\sloppy} % ensure bibliography respects margins
% removes unwanted fields for all references except misc
\AtEveryBibitem{%
	\ifboolexpr{not (test {\ifentrytype{misc}})}%
	{\clearfield{issn}}{}
}
\DeclareBibliographyAlias{software}{online} % remap software entries to online 
\usepackage{etoolbox} % fix underfull \hbox warnings in bibliography 
\apptocmd{\sloppy}{\hbadness 10000\relax}{}{} 
% Biblatex alphanumeric label - edit to include title for entries with no author and 'ND' for entries with no date; minimum 4 characters
\renewcommand*{\labelalphaothers}{}
\DeclareLabelalphaTemplate{
  \labelelement{
    \field[final]{shorthand}
    \field{label}
    \field[strwidth=4,strside=left,ifnames=1]{labelname}
	\field[strwidth=1,strside=left]{labelname}
	\field[strwidth=4,strside=left,ifnames=1]{title}
  }
  \labelelement{
		\field[strwidth=2,strside=right]{year}
		\field[strwidth=2,strside=right]{ND}
  }
}
% ignore spaces in author name or title
\DeclareNolabel{
  \nolabel{\regexp{[\p{Z}\p{P}\p{S}\p{C}]+}}
}

% PANDOC ----------------------
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\usepackage{microtype}
% \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}

% Fix footnotes in tables (requires footnote package)
\IfFileExists{footnote.sty}{\usepackage{footnote}\makesavenoteenv{longtable}}{}
\usepackage{grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
% set default figure placement to htbp
\makeatletter
\def\fps@figure{!htb}
\makeatother